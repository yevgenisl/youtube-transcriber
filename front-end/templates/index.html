<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Word Learning</title>
  <link rel="stylesheet" href="https://unpkg.com/ag-grid-community/styles/ag-grid.css">
  <link rel="stylesheet" href="https://unpkg.com/ag-grid-community/styles/ag-theme-alpine.css">
  <style>
    .tab { margin: 10px; cursor: pointer; padding: 10px; background: #f0f0f0; border: 1px solid #ccc; }
    .tab.active { background: #007bff; color: white; }
    #chosenWordsContainer { display: none; margin-top: 20px; }
    #myGrid { height: 400px; width: 100%; margin-top: 20px; }
    #buttonsContainer {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 4px;
    }
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.4);
    }
    .modal-content {
      background-color: #fefefe;
      margin: 5% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-height: 80vh;
      overflow-y: auto;
      border-radius: 8px;
    }
    .modal-header {
      position: sticky;
      top: 0;
      background-color: #fefefe;
      padding-bottom: 20px;
      border-bottom: 1px solid #eee;
      margin-bottom: 10px;
    }
    .modal-body {
      max-height: calc(80vh - 100px);
      overflow-y: auto;
    }
    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close:hover {
      color: black;
    }
    .highlight {
      background-color: yellow;
      padding: 2px 4px;
      border-radius: 3px;
    }
    .sentence {
      margin: 10px 0;
      padding: 10px;
      border-bottom: 1px solid #eee;
    }
    .timestamp {
      color: #666;
      font-size: 0.9em;
      margin-right: 10px;
      background-color: #f5f5f5;
      padding: 2px 6px;
      border-radius: 3px;
      cursor: pointer;
    }
    .timestamp:hover {
      background-color: #e0e0e0;
    }
    .sentence-content {
      display: inline;
    }
    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 10px;
    }
    .modal-buttons button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .modal-buttons button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .translate-btn {
      background-color: #4CAF50;
      color: white;
    }
    .add-word-btn {
      background-color: #2196F3;
      color: white;
    }
  </style>
</head>
<body>

  <div>
    <button class="tab active" id="wordsTab">Words</button>
    <button class="tab" id="chosenWordsTab">Chosen Words</button>
    <button class="tab" id="historyTab">History</button>
  </div>

  <!-- Words Tab Content -->
  <div id="wordsContainer">
    <div style="margin-bottom: 10px;">
      <label for="videoId">YouTube Video ID:</label>
      <input type="text" id="videoId" placeholder="Enter video ID" style="margin-left: 10px; padding: 5px;">
    </div>
    <div id="videoMetadata" style="margin-bottom: 10px; display: none;">
      <h3 id="videoTitle"></h3>
      <div id="videoContainer" style="margin: 20px 0;"></div>
    </div>
    <div id="myGrid" class="ag-theme-alpine"></div>
    <div id="buttonsContainer">
        <button id="submitBtn">Submit Checked</button>
        <button id="nextSetBtn">Next Set of Words</button>
    </div>
  </div>

  <!-- Chosen Words Tab Content -->
  <div id="chosenWordsContainer">
    <div id="chosenWordsGrid" class="ag-theme-alpine" style="height: 400px; width: 100%;"></div>
    <div id="chosenWordsButtonsContainer" style="display: flex; justify-content: center; gap: 10px; margin-top: 10px;">
      <button id="searchSentencesBtn" disabled>Search Sentences</button>
    </div>
  </div>

  <!-- Modal for displaying sentences -->
  <div id="sentencesModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="close">&times;</span>
        <h2 id="modalTitle"></h2>
        <div class="modal-buttons">
          <button id="translateBtn" class="translate-btn" disabled>Translate Selection</button>
          <button id="addWordBtn" class="add-word-btn" disabled>Add Selected Word</button>
        </div>
      </div>
      <div class="modal-body">
        <div id="sentencesContainer"></div>
      </div>
    </div>
  </div>

  <!-- Modal for displaying last viewed videos -->
  <div id="historyModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <span class="close">&times;</span>
        <h2>Recently Viewed Videos</h2>
      </div>
      <div class="modal-body">
        <div id="historyGrid" class="ag-theme-alpine" style="height: 400px; width: 100%;"></div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/ag-grid-community@29.0.0/dist/ag-grid-community.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      let chosenWordsGridApi = null;
      let historyGridApi = null;
      const modal = document.getElementById('sentencesModal');
      const historyModal = document.getElementById('historyModal');
      const closeBtn = document.getElementsByClassName('close')[0];
      const translateBtn = document.getElementById('translateBtn');
      const addWordBtn = document.getElementById('addWordBtn');

      // Close modals when clicking the X button
      closeBtn.onclick = function() {
        modal.style.display = "none";
        historyModal.style.display = "none";
      }

      // Close modals when clicking outside of them
      window.onclick = function(event) {
        if (event.target == modal) {
          modal.style.display = "none";
        }
        if (event.target == historyModal) {
          historyModal.style.display = "none";
        }
      }

      // Function to highlight word in sentence
      function highlightWord(sentence, word) {
        const regex = new RegExp(`\\b${word}\\b`, 'gi');
        return sentence.replace(regex, match => `<span class="highlight">${match}</span>`);
      }

      // Function to display sentences in modal
      function displaySentences(word, sentences) {
        const modalTitle = document.getElementById('modalTitle');
        const sentencesContainer = document.getElementById('sentencesContainer');
        const videoId = document.getElementById('videoId').value;
        
        modalTitle.textContent = `Sentences containing "${word}"`;
        sentencesContainer.innerHTML = '';
        
        sentences.forEach(sentenceData => {
          const sentenceDiv = document.createElement('div');
          sentenceDiv.className = 'sentence';
          
          // Create timestamp link
          const timestampLink = document.createElement('a');
          timestampLink.className = 'timestamp';
          timestampLink.textContent = sentenceData.timestamp;
          timestampLink.href = `https://www.youtube.com/watch?v=${videoId}&t=${sentenceData.timestamp.replace(':', 'm')}s`;
          timestampLink.target = '_blank';
          timestampLink.onclick = function(e) {
            e.preventDefault();
            window.open(this.href, '_blank');
          };
          
          // Create sentence content span
          const contentSpan = document.createElement('span');
          contentSpan.className = 'sentence-content';
          contentSpan.innerHTML = highlightWord(sentenceData.sentence, word);
          
          // Append elements
          sentenceDiv.appendChild(timestampLink);
          sentenceDiv.appendChild(contentSpan);
          sentencesContainer.appendChild(sentenceDiv);
        });
        
        modal.style.display = "block";
      }

      // Initialize history grid
      function initHistoryGrid() {
        const historyGridOptions = {
          columnDefs: [
            { headerName: "Video Title", field: "video_title", flex: 2 },
            { headerName: "Video ID", field: "video_id", flex: 1 },
            { headerName: "Viewed At", field: "viewed_at", flex: 1 }
          ],
          defaultColDef: {
            resizable: true,
            sortable: true
          },
          rowData: null,
          rowSelection: 'single',
          onRowClicked: function(event) {
            const videoId = event.data.video_id;
            document.getElementById('videoId').value = videoId;
            // Switch to Words tab
            document.getElementById('wordsTab').classList.add('active');
            document.getElementById('chosenWordsTab').classList.remove('active');
            document.getElementById('historyTab').classList.remove('active');
            document.getElementById('wordsContainer').style.display = 'block';
            document.getElementById('chosenWordsContainer').style.display = 'none';
            // Load the video and its words
            loadNextSetOfWords();
            historyModal.style.display = "none";
          }
        };

        const historyGridDiv = document.getElementById('historyGrid');
        historyGridApi = new agGrid.Grid(historyGridDiv, historyGridOptions);
      }

      // Load history data
      function loadHistory() {
        fetch('/api/last_viewed_videos')
          .then(response => response.json())
          .then(data => {
            if (historyGridApi) {
              historyGridApi.gridOptions.api.setRowData(data);
            }
          })
          .catch(error => {
            console.error('Error loading history:', error);
            alert('Error loading video history');
          });
      }

      // Toggle active tab
      document.getElementById('wordsTab').addEventListener('click', function() {
        document.getElementById('wordsTab').classList.add('active');
        document.getElementById('chosenWordsTab').classList.remove('active');
        document.getElementById('historyTab').classList.remove('active');
        document.getElementById('wordsContainer').style.display = 'block';
        document.getElementById('chosenWordsContainer').style.display = 'none';
      });

      document.getElementById('chosenWordsTab').addEventListener('click', function() {
        document.getElementById('chosenWordsTab').classList.add('active');
        document.getElementById('wordsTab').classList.remove('active');
        document.getElementById('historyTab').classList.remove('active');
        document.getElementById('wordsContainer').style.display = 'none';
        document.getElementById('chosenWordsContainer').style.display = 'block';
        loadChosenWords();
      });

      document.getElementById('historyTab').addEventListener('click', function() {
        document.getElementById('historyTab').classList.add('active');
        document.getElementById('wordsTab').classList.remove('active');
        document.getElementById('chosenWordsTab').classList.remove('active');
        document.getElementById('wordsContainer').style.display = 'none';
        document.getElementById('chosenWordsContainer').style.display = 'none';
        historyModal.style.display = "block";
        if (!historyGridApi) {
          initHistoryGrid();
        }
        loadHistory();
      });

      // Custom Checkbox Renderer
      function checkboxCellRenderer(params) {
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = !!params.value;

        checkbox.addEventListener('change', function () {
          params.node.setDataValue(params.colDef.field, checkbox.checked);
        });

        return checkbox;
      }

      const columnDefs = [
        { headerName: "Word", field: "word" },
        {
          headerName: "Learn it!",
          field: "learn",
          editable: true,
          cellRenderer: checkboxCellRenderer
        }
      ];

      const gridOptions = {
        columnDefs: columnDefs,
        defaultColDef: {
          flex: 1,
          minWidth: 100,
          resizable: true,
        },
        rowData: null
      };

      const gridDiv = document.getElementById('myGrid');
      new agGrid.Grid(gridDiv, gridOptions);

      fetch('/api/words')
        .then(response => response.json())
        .then(data => {
          gridOptions.api.setRowData(data);
        });

      // Submit logic
      function submitCheckedWords() {
        const checkedWords = [];
        gridOptions.api.forEachNode(node => {
          if (node.data.learn === true) {
            checkedWords.push(node.data.word);
          }
        });

        fetch('/api/save', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ words: checkedWords })
        })
        .then(res => res.json())
        .then(res => {
          if (res.status !== 'success') {
            alert('Error saving: ' + res.message);
          }
        });
      }

      document.getElementById('submitBtn').addEventListener('click', submitCheckedWords);

      // Submit on Enter key
      document.addEventListener('keydown', function (event) {
        if (event.key === 'Enter') {
          event.preventDefault(); // Prevent default behavior like form submit
          if (event.target.id === 'videoId') {
            loadNextSetOfWords();
          } else {
            submitCheckedWords();
          }
        }
      });

      // Load Chosen Words
      function loadChosenWords() {
        if (!chosenWordsGridApi) {
          const chosenWordsGridOptions = {
            columnDefs: [
              { headerName: "Word", field: "word" },
              { headerName: "Translation", field: "translation" },
              { headerName: "Chosen At", field: "chosen_at" }
            ],
            defaultColDef: {
              flex: 1,
              minWidth: 100,
              resizable: true,
            },
            rowData: null,
            rowSelection: 'single',
            onSelectionChanged: function() {
              const selectedRows = chosenWordsGridApi.gridOptions.api.getSelectedRows();
              document.getElementById('searchSentencesBtn').disabled = selectedRows.length === 0;
            }
          };

          const chosenWordsGridDiv = document.getElementById('chosenWordsGrid');
          chosenWordsGridApi = new agGrid.Grid(chosenWordsGridDiv, chosenWordsGridOptions);

          // Add event listener for the search sentences button
          document.getElementById('searchSentencesBtn').addEventListener('click', function() {
            const selectedRows = chosenWordsGridApi.gridOptions.api.getSelectedRows();
            if (selectedRows.length > 0) {
              const word = selectedRows[0].word;
              const videoId = document.getElementById('videoId').value;
              
              if (!videoId) {
                alert('Please enter a video ID first');
                return;
              }

              fetch(`/api/search_sentences?word=${encodeURIComponent(word)}&video_id=${encodeURIComponent(videoId)}`)
                .then(response => response.json())
                .then(data => {
                  if (data.error) {
                    alert(data.error);
                  } else {
                    displaySentences(word, data.sentences);
                  }
                })
                .catch(error => {
                  console.error('Error:', error);
                  alert('Error searching for sentences');
                });
            }
          });
        }

        // Fetch and populate the grid with chosen words
        fetch('/api/chosen_words')
          .then(response => response.json())
          .then(data => {
            chosenWordsGridApi.gridOptions.api.setRowData(data);
          });
      }


      // Load Next Set of Words
      function loadNextSetOfWords() {
        const videoId = document.getElementById('videoId').value;
        if (!videoId) {
          alert('Please enter a video ID');
          return;
        }

        // First fetch video metadata
        fetch(`/api/video_metadata?video_id=${videoId}`)
          .then(response => response.json())
          .then(data => {
            if (data.error) {
              alert('Error getting video metadata: ' + data.error);
              return;
            }
            
            // Display video metadata
            const metadataDiv = document.getElementById('videoMetadata');
            const titleElement = document.getElementById('videoTitle');
            const videoContainer = document.getElementById('videoContainer');
            
            metadataDiv.style.display = 'block';
            titleElement.textContent = data.title;
            
            // Embed the video if oEmbed HTML is available
            if (data.oembed_html) {
              videoContainer.innerHTML = data.oembed_html;
            }
            
            // Then fetch the next set of words
            return fetch(`/api/next_set_of_words?video_id=${videoId}`);
          })
          .then(response => response.json())
          .then(data => {
            gridOptions.api.setRowData(data);
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error loading words. Please check the video ID and try again.');
          });
      }

      document.getElementById('nextSetBtn').addEventListener('click', loadNextSetOfWords);

      // Handle text selection in modal
      document.addEventListener('selectionchange', function() {
        const selection = window.getSelection();
        const selectedText = selection.toString().trim();
        translateBtn.disabled = !selectedText;
        addWordBtn.disabled = !selectedText;
      });

      // Handle translation button click
      translateBtn.addEventListener('click', function() {
        const selection = window.getSelection();
        const selectedText = selection.toString().trim();
        
        if (selectedText) {
          fetch('/api/translate', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ word: selectedText })
          })
          .then(response => response.json())
          .then(data => {
            if (data.error) {
              alert(data.error);
            } else {
              alert(`Translation: ${data.translation}`);
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error translating text');
          });
        }
      });

      // Handle add word button click
      addWordBtn.addEventListener('click', function() {
        const selection = window.getSelection();
        const selectedText = selection.toString().trim();
        
        if (selectedText) {
          fetch('/api/save', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ words: [selectedText] })
          })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'success') {
              alert(`Word "${selectedText}" added successfully!`);
              // Refresh the chosen words grid if it's visible
              if (chosenWordsGridApi) {
                loadChosenWords();
              }
            } else {
              alert('Error adding word: ' + data.message);
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('Error adding word');
          });
        }
      });
    });
  </script>

</body>
</html>
